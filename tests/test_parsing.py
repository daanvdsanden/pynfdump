import pynfdump

def parse_search_helper(txt):
    lines = [l.strip() for l in txt.strip().splitlines()]
    return list(pynfdump.Dumper().parse_search(lines))

def parse_stats(txt):
    lines = [l.strip() for l in txt.strip().splitlines()]
    return list(pynfdump.Dumper().parse_stats(lines))

def test_parse_1():
    out = """2010-08-16 11:28:43,2010-08-16 11:28:46,2.992,85.85.169.79,85.184.5.68,3124,135,TCP,....S.,0,0,40,2560,0,0,34,34,0,0,0,0,0,0,0.0.0.0,0.0.0.0,0,0,00:00:00:00:00:00,00:00:00:00:00:00,00:00:00:00:00:00,00:00:00:00:00:00,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0.0.0.0,0/0
2010-08-16 11:28:43,2010-08-16 11:28:46,2.973,85.185.194.75,85.184.5.240,5525,445,TCP,....S.,0,0,116,5568,0,0,34,34,0,0,0,0,0,0,0.0.0.0,0.0.0.0,0,0,00:00:00:00:00:00,00:00:00:00:00:00,00:00:00:00:00:00,00:00:00:00:00:00,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0.0.0.0,0/0
2010-08-16 11:28:46,2010-08-16 11:28:46,0.000,85.184.5.14,195.176.255.154,0,2816,ICMP,......,0,192,1,56,0,0,34,3,0,0,0,0,0,0,0.0.0.0,0.0.0.0,0,0,00:00:00:00:00:00,00:00:00:00:00:00,00:00:00:00:00:00,00:00:00:00:00:00,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0-0-0,0.0.0.0,0/0
    """

    expected = [
        {'srcip': '85.85.169.79', 'dstip': '85.184.5.68' },
        {'srcip': '85.185.194.75', 'dstip': '85.184.5.240', },
        {'srcip': '85.184.5.14', 'dstip': '195.176.255.154',  },
    ]

    for a,b in zip(parse_search_helper(out), expected):
        for k,v in b.items():
            msg =  "field:%s expected:%s actual:%s" % (k, v, a[k])
            assert str(a[k]) == v, msg
